---
- hosts: all
  vars_files:
    - vars/clojurians_log_secrets.yml
  become: true
  # gather_facts needs to be false only for the bootstrap installation of python.
  # There may be other reasons to set gather_facts to false as well.
  # Having to do with multiple playbooks.
  gather_facts: false
  vars:
    database_name: "clojurians_log_datomic"
    database_user: "clojurians_log"
    database_hostname: "localhost"
    database_port: 5432
    clojurians_app_http_port: 4242
    datomic_pro_version: 0.9.5561.56
    datomic_object_cache_max: 2g
    clojure_app_env_vars: |
      JVM_OPTS="-Dclojure.server.myrepl={:port,50505,:accept,clojure.core.server/repl} -Xmx8g -Xms2g -Ddatomic.ObjectCacheMax=7g -Ddatomic.memcachedServers=127.0.0.1:11211"
  pre_tasks:
    # install python only if ping fails
    - name: Try ping first to see if a python already exists
      ping:
      ignore_errors: true
      register: chkping
    - name: Bootstrap installation of python
      raw: apt-get -y install python
      when: chkping is failed
    - name: Gather facts anyways
      action: setup
  tasks:
    # Keys first, then repos, then the dist-upgrade.
    - name: Add repository for ansible
      apt_repository:
        repo: ppa:ansible/ansible
        state: present
    - name: Install the lastest versions of listed packages
      apt:
        name: "{{ item }}"
        state: latest
      loop:
        - ansible
        - aptitude              # to shut up dist-upgrade warning
        - curl
        - emacs
        - git
        - htop                  # To view processes
        - openjdk-8-jdk         # For Clojure
        - python3
        - rlwrap                # For clj
        - screen
        - unzip                 # for ansible unarchive module
    - name: Purge installed apps
      apt:
        name: "{{ item }}"
        state: absent
        purge: yes
      loop:
        - ubuntu-web-launchers  # to remove Amazon icon from launcher
    - name: Do a dist-upgrade
      apt:
        upgrade: dist
        update_cache: yes
    # Unfortunately, the apt version of lein is quite old.
    - name: Set up Leiningen
      import_role:
        name: leiningen
    # Too bad we cannot use the alternatives module
    # as it would require listing each java command.
    - name: Check if jdk8 is default
      command: update-alternatives --display java
      register: chkjava
      changed_when: false
      check_mode: false
    - name: Choose jdk8 as default for Clojure
      command: update-java-alternatives --set java-1.8.0-openjdk-amd64
      when: chkjava.stdout.find('link currently points to /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java') == -1
    # Clean up
    - name: Remove unneeded apt stuff
      apt:
        autoremove: yes
    # Firewall settings
    - name: Set firewall settings to allow ssh, http/s
      import_role:
        name: firewall
    #########
    # Now set up the users
    - name: Set up plexus
      import_role:
        name: setup_user
      tags: setup_user
      vars:
        username: plexus
        full_name: Arne Brasseur
        github_username: plexus
    - name: Set up lispyclouds
      import_role:
        name: setup_user
      tags: setup_user
      vars:
        username: lispyclouds
        full_name: Rahul De
        github_username: lispyclouds
    - name: Set up victorb
      import_role:
        name: setup_user
      tags: setup_user
      vars:
        username: victorb
        full_name: Victor Bjelkholm
        github_username: victorb
    - name: Set up dorab
      import_role:
        name: setup_user
      tags: setup_user
      vars:
        username: dorab
        full_name: Dorab Patel
        github_username: bombaywalla
    # TODO: might want to remove some users such as vagrant or ubuntu??
    # Harden sshd. Note: This MUST come after at least one sudoable user having a pubkey login.
    - name: Harden sshd
      import_role:
        name: harden_sshd
    # Now install the programs
    - name: Install memcached
      import_role:
        name: geerlingguy.memcached
      tags: memcached
      vars:
        memcached_memory_limit: 4096
    - name: Install postgres
      import_role:
        name: geerlingguy.postgresql
      tags: postgres
      vars:
        postgresql_databases:
          - name: "{{ database_name }}"
        postgresql_users:
          - name: "{{ database_user }}"
            password: "{{ database_password }}"
            db: "{{ database_name }}"
            priv: "ALL"
    - name: Install datomic-pro
      import_role:
        name: plexus.datomic-pro
      tags: datomic
      vars:
        datomic_memcached: 127.0.0.1:11211
    # Now the Clojurians Log app stuff
    - name: Install the Clojure Web app
      import_role:
        name: plexus.clojure-web-app
      tags: clojure-web-app
      vars:
        clojure_app_authorized_keys: |
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCf99gah0qnmLQn3yix8NFk2JsV0kHTzciLLHVUFfJmCsb4sHY4yKAuiMfp9E0s71tIsmVfw9GdNfhit/nHqQG/VGjgYSR4zIRD0Rr0V5GrDsSS/jWotNfb0JXt+Up310BE/diL7vi8uTwe3t5THymiuibFLgoaHvnbFE1VYojpyiGcSOGmE9GrDOuN08mg2ynb6FAK2/tnfo+ZBwl7g3A9pMvjHUwRzFyq+Z+Mdmf8c8x4qLrikUNv/U3TL1WPXUB4rwiUwhnRqadR/uBGYUwWJ1vfh4wl1aZqnyVRM3YfDmb5720m2IXX1MPH0CDio8moT9bwIfSRyBUt3zDuft/R arne@twoflower
        clojure_app_main_command: "/usr/local/bin/lein with-profile +production,-dev run {{ clojure_app_home_dir }}/config.edn"
        clojure_app_health_check_url: "http://localhost:{{clojurians_app_http_port}}/healthcheck"
        clojure_app_service_start_after: datomic.service
    - name: Install the Clojurians Log app
      import_role:
        name: plexus.clojurians-log
      tags: clojurians-log
